# Digital Workspace OS — 数据库与数据模型设计

> 采用 SQLite（`better-sqlite3`）实现单机持久化；定义核心表结构、索引策略、事务一致性、迁移与备份。

---

## 一、目标与范围

- 单机、轻量、跨平台，满足 Workspace/Tab/Settings/Plugin 状态的持久化需求
- 读写性能优先，保证切换/恢复流程的原子性与可靠性

---

## 二、数据模型与关系（ER 概述）

- `workspaces` 1:N `tabs`
- `workspaces` 1:N `settings`
- `workspaces` 1:N `plugin_state`

---

## 三、表结构与索引策略

### 3.1 workspaces（工作空间）

```sql
CREATE TABLE IF NOT EXISTS workspaces (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  icon TEXT,
  color TEXT,
  partition TEXT UNIQUE NOT NULL,
  created_at INTEGER NOT NULL,
  last_accessed_at INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_workspaces_last_accessed ON workspaces(last_accessed_at);
```

### 3.2 tabs（标签页）

```sql
CREATE TABLE IF NOT EXISTS tabs (
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  url TEXT NOT NULL,
  title TEXT,
  favicon TEXT,
  active INTEGER DEFAULT 0,
  suspended INTEGER DEFAULT 0,
  state TEXT, -- JSON：休眠时序列化状态（滚动位置等）
  created_at INTEGER NOT NULL,
  last_accessed_at INTEGER NOT NULL,
  FOREIGN KEY(workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_tabs_ws ON tabs(workspace_id);
CREATE INDEX IF NOT EXISTS idx_tabs_active ON tabs(active);
CREATE INDEX IF NOT EXISTS idx_tabs_last_accessed ON tabs(last_accessed_at);
```

### 3.3 settings（工作空间设置）

```sql
CREATE TABLE IF NOT EXISTS settings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  workspace_id TEXT NOT NULL,
  key TEXT NOT NULL,
  value TEXT NOT NULL, -- JSON
  FOREIGN KEY(workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
  UNIQUE(workspace_id, key)
);
```

### 3.4 plugin_state（插件状态）

```sql
CREATE TABLE IF NOT EXISTS plugin_state (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  workspace_id TEXT NOT NULL,
  plugin_id TEXT NOT NULL,
  enabled INTEGER DEFAULT 1,
  data TEXT, -- JSON：插件私有状态（隔离存储）
  updated_at INTEGER NOT NULL,
  FOREIGN KEY(workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
  UNIQUE(workspace_id, plugin_id)
);
```

### 3.5 schema_version（架构版本）

```sql
CREATE TABLE IF NOT EXISTS schema_version (
  version INTEGER PRIMARY KEY,
  applied_at INTEGER NOT NULL,
  description TEXT
);
```

---

## 四、事务与一致性

- 切换 Workspace：
  - 事务步骤：保存当前 Workspace 的 `tabs` 状态 → 更新 `last_accessed_at` → 恢复目标 Workspace 的 `tabs` → 提交
- 原子性保证：所有涉及多表的批量写入均在单事务内完成

---

## 五、典型查询与操作

- 列出 Workspace：`SELECT * FROM workspaces ORDER BY last_accessed_at DESC;`
- 列出某 Workspace 的 Tabs：`SELECT * FROM tabs WHERE workspace_id = ? ORDER BY last_accessed_at DESC;`
- 更新 Tab 休眠状态：`UPDATE tabs SET suspended = 1, state = ? WHERE id = ?;`
- 写入设置：`INSERT OR REPLACE INTO settings(workspace_id, key, value) VALUES(?, ?, ?);`

---

## 六、迁移与版本化

- 使用 `schema_version` 记录当前版本；每次升级执行增量迁移脚本（vN→vN+1）
- 回滚策略：对 DDL 变更保留反向迁移，必要时备份 `.db` 文件后再升级

---

## 七、备份与恢复

- 文件级备份：复制数据库文件（应用退出后执行）
- JSON 导出：导出 `workspaces/tabs/settings/plugin_state` 为 JSON；导入时按外键顺序写回

---

## 八、数据脱敏与安全

- 不存储用户凭证/密码等敏感信息；如未来需要，使用加密存储并进行最小化保留
- 插件数据隔离在 `plugin_state`，仅插件沙箱可访问其私有数据

---

## 九、交叉引用

- `doc/技术架构设计文档.md`（Storage Manager 职责）
- `doc/MVP 开发计划.md`（存储实现任务）